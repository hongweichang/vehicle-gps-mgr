<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<meta name="keywords" content=""/>
	<link rel="stylesheet" href="css/style.css" />
	<link type="text/css" href="css/redmond/jquery-ui-1.8.1.custom.css" rel="stylesheet" />
	
	<script language="javascript" src="http://api.51ditu.com/js/maps.js"></script>
	<script language="javascript" src="js/jquery-1.4.2.js" ></script>
	<script language="javascript" src="js/jquery-ui-1.8.1.custom.min.js" ></script>
	<script language="javascript" src="js/home_page/home_page.js"></script>
	<script language="javascript" src="js/alert/opinion.js"></script>
	
	<script type="text/javascript">
	function closeIframe(){
		$("#externalSite").dialog("close");
		$("#externalSite").remove();
	}
		
	$(function() {
		$('#addAdvice').click(function(e) {
			$.post("index.php?a=903&id="+id,function(data){
				$("#opinion").html(data);
				$("#opinion").dialog("open");
			});
		});

		$( "#opinion" ).dialog({
			   close: function(event, ui) { alertInfo(); }
		});
		
		$('.button_font').click(function(e) {
			e.preventDefault();
			var $this = $(this);
			var horizontalPadding = 30;
			var verticalPadding = 30;
	        $('<iframe id="externalSite" class="externalSite"  src="' + $this.attr("url")+ '" frameborder="0"/>').dialog({
	            title: ($this.attr('title')) ? $this.attr('title') : 'External Site',
	            autoOpen: true,
	            width: 1000,
	            height: 500,
	            modal: true,
	            resizable: true,
				autoResize: true,
	            overlay: {
	                opacity: 0.5,
	                background: "black"
	            }
	        }).width(1000 - horizontalPadding).height(500 - verticalPadding);	      
		});

		$('#lookMore').click(function(e) {
			e.preventDefault();
			var $this = $(this);
			var horizontalPadding = 30;
			var verticalPadding = 30;
	        $('<iframe id="externalSite" class="externalSite"  src="' + $this.attr("url")+ '" frameborder="0"/>').dialog({
	            title: ($this.attr('title')) ? $this.attr('title') : 'External Site',
	            autoOpen: true,
	            width: ($this.attr('showWidth')) ? $this.attr('showWidth') : '1000',
	            height: 500,
	            modal: true,
	            resizable: true,
				autoResize: true,
	            overlay: {
	                opacity: 0.5,
	                background: "black"
	            }
	        }).width(1000 - horizontalPadding).height(500 - verticalPadding);	      
		});
	});
	</script>
	
</head>
<body>
	<div id="opinion"></div>
	<div id="header">
		<div id="carInfor" style='float:left;width:60%; height:17px;'></div>
		<div class="header_content"> 
		    
			<div class="hearder_div"><a href="{{URL_MANAGE}}" target="_blank">管理中心</a></div>
			<div class="hearder_div"><a href="{{URL_LOGOUT}}" onclick="window.close();" target="_blank">退出</a></div>
		</div>
	</div>
	<div id="map"></div>
	<div id="content">
		  <div class="button_content">
				<ul id="nav">
					<li class="jsbutton" id="vehicle">
						<div class="button_font" url="index.php?a=1" title="选择车辆">选择车辆</div>
					</li>
					<li class="jsbutton" id="sendInfo">
						<div class="button_font" url="index.php?a=201" title="发布信息">发布信息</div>
					</li>
					<li class="jsbutton" id="searchInfo">
						<div class="button_font" url="index.php?a=301" title="查询信息" showWidth="1100">查询信息</div>
					</li>
					<li class="jsbutton" id="statistic">
						<div class="button_font" url="index.php?a=401" title="统计分析">统计分析</div>
					</li>
					<li class="jsbutton" id="setting">
						<div class="button_font" url="index.php?a=5017" title="设置">设置</div>
				 </ul>
			</div>
			<div class="alertInfo">
			    <div id="lamp" class="lamp"></div>
			    <div class="alert_div">
					<div id="newAlert" class="newAlert"></div>
					<div  class="new_alert">
							<div id="record" class="record"></div>
							
							<div class="operate" id="operate" >
								<div class="addAdvice" id="addAdvice"><a href="#">处理</a></div>
								<div class="lookMore" id="lookMore" url="index.php?a=901" title="告警列表"><a href='#' style='margin-left:5px;'>查 看更多</a></div>
						   </div>
				    </div>
			    </div>
		    </div>
	</div>  
	<script language="javascript">
			var state = 0; //操作状态  
			var map;  //声明51地图对象
			var control; //声明51地图控件
			var lat = 11636160;  //纬度
			var lon = 3991104;  // 经度
			var speed = 1000;  //速度/ms
			var marker1;
			var drawLine_arr;
			var host = "{{HOST}}";
			{{PAGE_REFRESH_TIME}}

			onLoadMap();
			
			//加载地图
			function onLoadMap()
			{
				window._LT_map_disableProgressBar=true;	//因为地图上的进度条可能会影响折线的事件触发，因此先禁止进度条的显示
				map=new LTMaps("map");
				map.centerAndZoom(new LTPoint(11640969,3994940),6);
				map.addControl(new LTStandMapControl());

				control = new LTZoomSearchControl();
			    control.setTop(10);
			    control.setLabel("选中矩形区域");
				map.addControl( control );
				map.handleMouseScroll();
				LTEvent.addListener(map,"dblclick",onDblClick);//绑定事件注册
				//选中区域
				LTEvent.addListener(control,"mouseup",drawRectangle);
				
				loadCompanyVehicle();
			}
			
			//初始化定位
			function loadCompanyVehicle(){
				
				$.ajax({
					type:"POST",
					url:"index.php?a=101", 
					dataType:"json",
					success:function(data){  
						var length = data.length; 

						if(length>0)
							map.clearOverLays(); //清除所有标点，重新加载新数据
							
						var points = new Array();
						 for(var i=0;i<length;i++){      
							   
							var number_plate = data[i]['number_plate']; //车牌号
							var gps_id = data[i]['gps_id']; //GPS编号
							var location_time = data[i]['location_time']; //当前定位时间 
							var point_longitude =  data[i]['cur_longitude']; //当前经度
							var point_latitude =  data[i]['cur_latitude']; //当前纬度 
							var cur_speed =  data[i]['cur_speed'];//当前速度
							var img_name =data[i]['cur_direction']; //图片名
							var vehicle_group_name = data[i]['group_name'];  //车队
							var driver_name = data[i]['driver_name']; //驾驶员
							var file_path = data[i]['file_path']; //文件路径
							var location_desc =  data[i]['location_desc']; //地址
							   
							//创建点对象
							marker1 =new LTMarker(new LTPoint(round(point_longitude),round(point_latitude)),
											 	  new LTIcon(host+"/"+file_path+"/"+img_name+".png"));

							points.push( new LTPoint(round(point_longitude),round(point_latitude)));
							//点对象设置内容
							var context = "车牌号："+number_plate+"<br>GPS编号："+gps_id+
										  "<br>车队："+vehicle_group_name+
										  "<br>驾驶员："+driver_name+
										  "<br>当前速度: "+cur_speed+"<br>当前定位时间:"+location_time+
										  "<br>当前地址: "+location_desc+"<br><br>"+
										  "<a href='#'>发送信息</a>&nbsp;&nbsp;&nbsp;<a href='#'>历史轨迹</a>";
							addInfoWin(marker1,context);

							//点添入地图中
							map.addOverLay(marker1);

							var text = new LTMapText( new LTPoint( round(point_longitude),round(point_latitude) ) );
							text.setLabel(number_plate ); 
							map.addOverLay( text ); 
						}  
						map.getBestMap(points);
						 
					 }
 				});	
				setTimeout("loadCompanyVehicle();",page_refresh_time*1000);
			}
			
			var moveLsitener;
			function onDblClick()//定义在双击的时候执行的函数
			{
				moveLsitener=LTEvent.addListener(map,"moveend",onMoveEnd);
				//因为系统默认双击的时候会将地图定位到中心，因此，只需要定义地图在定位到中心完成之后放大地图即可
			}
			function onMoveEnd()//定义地图在定位到中心完成之后执行的函数
			{
				LTEvent.removeListener(moveLsitener);//删除事件注册
				map.zoomIn();//放大地图
			}
			
			//关闭提示窗口
			function closeWindow(){
				$searchInfo.close();
			}

			//画历史轨迹路径
			function drawHistoryTrack(startTime,endTime){ 
				
				drawLine_arr = data; 
				newDrawLine();
				 
			}
	 
			//画新线
			function newDrawLine(){
				 
				var length = drawLine_arr.length; 
				if(length>0){
					 
				 		var points1 = new Array();

				 		var lon = drawLine_arr[0][0];
				 		var lat = drawLine_arr[0][1];
				 		var direction = drawLine_arr[0][2];

				 		var newLon = -1;
				 		var newLat = -1;

						points1.push( new LTPoint(round(lon), round(lat)));
					if(length>1){
						newLon = drawLine_arr[1][0];
						newLat = drawLine_arr[1][1];
						points1.push( new LTPoint(round(newLon),round(newLat)));
					}else{
						newLon = lon;
						newLat = lat;
						points1.push( new LTPoint(round(lon), round(lat)));
					} 
					drawLine_arr.shift();
					drawRunLine(points1,round(newLon),round(newLat),direction);
				}
				
			}
			
			
			//运行画线
			function drawRunLine(points1,lon,lat,direction){  
				
				map.centerAndZoom(new LTPoint(lon,lat),4);
				var polyLine1 = new LTPolyLine(points1);
				polyLine1.setLineColor("#ff0000");	//设置折线颜色 
				polyLine1.setLineStroke(2);	//设置折线线宽
				
				polyLine1.setLineArrow("None","None");
				//将折线添加到地图
				map.addOverLay( polyLine1 );
 
				map.removeOverLay(marker1);
				marker1 = new LTMarker( new LTPoint(lon,lat),new LTIcon("{{HOST}}/images/vehicle/red/"+direction+".png"));
				map.addOverLay(marker1 );

				setTimeout("newDrawLine();",speed);
			}

			/**
			  *车辆提示信息
			  * obj 添加对象
			  * context 添加内容
			  */
			function addInfoWin(obj,context){
				
				var info = new LTInfoWindow( obj );

				function shwoInfo(){
					info.setLabel(context);
					info.closeInfoWindowWithMouse();
					map.addOverLay(info);
				}
				LTEvent.addListener(obj,"click",shwoInfo); 
			} 
			
			/**
			  *  车辆请求定位	
			  *  str  车辆ID集合 格式"ID1,ID2,ID3,"
			  */
			function vehiclePosition(str){ 
				closeIframe();
				 $.ajax({
						type:"POST",
						url:"index.php?a=2&vehicleIds="+str, 
						dataType:"json",
						success:function(data){ 
							var length = data.length;
						
							for(var i=0;i<length;i++){        
								  
								var point_longitude = data[i][1]; //点经度
								var point_latitude =  data[i][2]; //点纬度
								var file_path = data[i][4]; //文件目录
								var img_name = data[i][3];  //图片名称

								//创建点对象
								marker1 =new LTMarker(new LTPoint(round(point_longitude),round(point_latitude)),
												 	  new LTIcon("{{HOST}}/"+file_path+"/"+img_name+".png"));

								//点对象设置内容
								addInfoWin(marker1,"经度："+point_longitude+"  纬度："+point_latitude);

								//点添入地图中
								map.addOverLay(marker1);
							}
							map.resizeMapDiv();
							map.centerAndZoom("beijing",12);
						 }
	 				});
			}

			
			//经纬度五舍五入
			function round(v,e){
				v= v*100000;
				var   t=1;   
					for(;e>0;t*=10,e--);   
					for(;e<0;t/=10,e++);   

				return  Math.round(v*t)/t;   
			  } 
			 
  
			//手动画矩形
			function drawRectangle(){
				map.clearOverLays();
				//矩形地理区域的对象
				var drawBounds = control.getBoundsLatLng();

				var lonMin = drawBounds.getXmin();//最小经度
				var latMin = drawBounds.getYmin();//最小纬度
				var lonMax = drawBounds.getXmax();//最大经度
				var latMax = drawBounds.getYmax();//最大纬度

				//生成矩形地理区域
				var rectangleBounds =new LTBounds(lonMin,latMin,lonMax,latMax);

				//在地图画出矩形图 
				map.addOverLay(new LTRect(rectangleBounds));
			}

	 		
		</script>
	</body> 
</html>